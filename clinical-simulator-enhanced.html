<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinical Decision Simulator</title>
    <style>
/* Clinical Decision Simulator - Complete Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

/* Medical monitor effect */
.monitor-lines {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.02;
    background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 0, 0.1) 2px,
        rgba(0, 255, 0, 0.1) 4px
    );
    pointer-events: none;
    z-index: 0;
}

/* Menu Screen */
.menu-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
}

.menu-header {
    text-align: center;
    margin-bottom: 40px;
    animation: fadeIn 0.8s ease;
}

.menu-header h1 {
    font-size: 48px;
    color: #4CAF50;
    margin-bottom: 10px;
    text-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
}

.menu-header p {
    font-size: 20px;
    opacity: 0.8;
}

.scenario-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    max-width: 1000px;
    width: 100%;
    margin-bottom: 30px;
}

.scenario-card {
    background: rgba(40, 40, 60, 0.8);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    animation: slideUp 0.6s ease;
}

.scenario-card:hover {
    border-color: #4CAF50;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
}

.scenario-icon {
    font-size: 36px;
    margin-bottom: 10px;
}

.scenario-title {
    font-size: 20px;
    color: #4CAF50;
    margin-bottom: 8px;
    font-weight: 600;
}

.scenario-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
    font-size: 13px;
    opacity: 0.8;
}

.difficulty-basic { color: #4CAF50; }
.difficulty-intermediate { color: #FFC107; }
.difficulty-advanced { color: #FF5722; }

.scenario-description {
    font-size: 14px;
    line-height: 1.6;
    opacity: 0.9;
}

.coming-soon {
    opacity: 0.5;
    pointer-events: none;
}

/* Loading screen */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #1a1a2e;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    transition: opacity 0.5s ease;
}

.loading-icon {
    font-size: 48px;
    animation: pulse 1.5s ease infinite;
    margin-bottom: 20px;
}

.loading-text {
    font-size: 20px;
    color: #4CAF50;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Main container */
.simulator-container {
    position: relative;
    z-index: 1;
    width: 95%;
    max-width: 1400px;
    height: 90vh;
    max-height: 900px;
    background: rgba(30, 30, 45, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Header with vitals */
.header {
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.9), rgba(139, 0, 0, 0.9));
    padding: 15px 25px;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    flex-wrap: nowrap;
}

.title {
    font-size: 22px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.title-icon {
    font-size: 26px;
}

/* Vital signs monitor */
.vitals-monitor {
    display: flex;
    flex-direction: row;
    gap: 15px;
    align-items: center;
    background: rgba(0, 0, 0, 0.3);
    padding: 10px 20px;
    border-radius: 10px;
}

.vital-display {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 0 15px;
    border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.vital-display:last-child {
    border-right: none;
}

.vital-label {
    font-size: 12px;
    text-transform: uppercase;
    opacity: 0.7;
    font-weight: 600;
}

.vital-value {
    font-size: 18px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    white-space: nowrap;
}

.vital-critical {
    color: #ff4444;
    animation: pulse 1s ease-in-out infinite;
}

.vital-warning {
    color: #ffaa00;
}

.vital-normal {
    color: #44ff44;
}

/* Score tracking */
.score-panel {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 20px;
    border-radius: 10px;
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: center;
    flex-shrink: 0;
}

.score-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.score-value {
    font-size: 18px;
    font-weight: bold;
    color: #4CAF50;
}

/* Main content area */
.content-wrapper {
    flex: 1;
    display: flex;
    gap: 20px;
    padding: 20px;
    overflow: hidden;
}

/* Clinical scenario panel */
.scenario-panel {
    flex: 2;
    background: rgba(40, 40, 60, 0.6);
    border-radius: 15px;
    padding: 25px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.patient-header {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.patient-info {
    font-size: 16px;
    line-height: 1.6;
}

.clinical-status {
    margin-top: 20px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border-left: 4px solid #ff4444;
}

.status-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #ff4444;
}

.current-situation {
    font-size: 15px;
    line-height: 1.8;
    color: #e0e0e0;
}

/* Decision panel */
.decision-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    position: relative;
}

.decision-header {
    font-size: 18px;
    font-weight: 600;
    color: #4CAF50;
    margin-bottom: 10px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#decisionsContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto;
}

/* Decision Path Section */
.decision-path-section {
    margin-top: auto;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 15px;
}

.decision-path-button {
    width: 100%;
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4CAF50;
    color: #4CAF50;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
}

.decision-path-button:hover {
    background: rgba(76, 175, 80, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.path-toggle-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.path-history-container {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 15px;
    transition: max-height 0.3s ease;
}

.path-history-container.collapsed {
    max-height: 0;
    overflow: hidden;
}

.decision-button {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
    border: 2px solid rgba(76, 175, 80, 0.3);
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.decision-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.2), transparent);
    transition: left 0.5s ease;
}

.decision-button:hover {
    border-color: #4CAF50;
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
}

.decision-button:hover::before {
    left: 100%;
}

.decision-label {
    font-size: 14px;
    color: #4CAF50;
    text-transform: uppercase;
    margin-bottom: 8px;
    font-weight: 600;
}

.decision-text {
    font-size: 15px;
    color: #e0e0e0;
    line-height: 1.5;
}

/* Path history items */
.path-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    font-size: 13px;
    border-left: 3px solid #666;
    background: rgba(100, 100, 100, 0.1);
    transition: all 0.3s ease;
    animation: slideInLeft 0.3s ease;
    cursor: pointer;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.path-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.path-item.correct {
    border-left-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.path-item.incorrect {
    border-left-color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
}

.path-item.partial {
    border-left-color: #ffaa00;
    background: rgba(255, 170, 0, 0.1);
}

.path-result {
    font-size: 11px;
    margin-top: 5px;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Feedback modal */
.feedback-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.feedback-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 15px;
    padding: 30px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid rgba(255, 255, 255, 0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.feedback-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 600;
}

.feedback-correct {
    color: #4CAF50;
}

.feedback-incorrect {
    color: #ff4444;
}

.feedback-partial {
    color: #ffaa00;
}

.feedback-icon {
    font-size: 36px;
}

.feedback-text {
    font-size: 16px;
    line-height: 1.8;
    color: #e0e0e0;
    margin-bottom: 15px;
}

.reference-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #2196F3;
}

.reference-label {
    font-size: 12px;
    text-transform: uppercase;
    color: #2196F3;
    margin-bottom: 5px;
}

.reference-text {
    font-size: 14px;
    color: #e0e0e0;
    cursor: pointer;
    text-decoration: underline;
    transition: color 0.3s ease;
}

.reference-text:hover {
    color: #4CAF50;
}

.reference-link {
    color: #2196F3;
    font-size: 13px;
    font-style: italic;
    cursor: pointer;
    text-decoration: none;
    margin-left: 5px;
    transition: color 0.3s ease;
}

.reference-link:hover {
    color: #4CAF50;
    text-decoration: underline;
}

/* Reference modal */
.reference-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.reference-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 15px;
    padding: 40px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #2196F3;
    animation: slideIn 0.3s ease;
}

.reference-header {
    font-size: 24px;
    color: #2196F3;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-button {
    font-size: 28px;
    color: #e0e0e0;
    cursor: pointer;
    transition: color 0.3s ease;
    background: none;
    border: none;
}

.close-button:hover {
    color: #ff4444;
}

.reference-body {
    font-size: 16px;
    line-height: 1.8;
    color: #e0e0e0;
}

.reference-body h3 {
    color: #4CAF50;
    margin-top: 20px;
    margin-bottom: 10px;
}

.reference-body ul {
    margin-left: 20px;
    margin-bottom: 15px;
}

.reference-body li {
    margin-bottom: 8px;
}

.reference-body strong {
    color: #4CAF50;
}

.reference-body table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
}

.reference-body th, .reference-body td {
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    text-align: left;
}

.reference-body th {
    background: rgba(33, 150, 243, 0.2);
}

.outcome-points {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-size: 18px;
    margin-bottom: 15px;
}

.continue-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.continue-button:hover {
    background: linear-gradient(135deg, #45a049, #4CAF50);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
}

/* Completion screen */
.completion-screen {
    padding: 40px;
    max-width: 900px;
    margin: 0 auto;
}

.completion-title {
    font-size: 36px;
    color: #4CAF50;
    margin-bottom: 30px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.completion-icon {
    font-size: 42px;
    animation: bounce 1s ease infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.completion-summary {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: left;
    border: 1px solid rgba(76, 175, 80, 0.2);
}

.completion-intro {
    font-size: 18px;
    line-height: 1.8;
    color: #e0e0e0;
    margin-bottom: 25px;
    text-align: center;
}

.learning-points-section {
    margin-top: 25px;
}

.learning-points-title {
    font-size: 22px;
    color: #4CAF50;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.learning-points-title::before {
    content: "📚";
    font-size: 24px;
}

.learning-points-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.learning-point-item {
    background: rgba(76, 175, 80, 0.1);
    border-left: 4px solid #4CAF50;
    padding: 15px 20px;
    border-radius: 8px;
    display: flex;
    gap: 15px;
    align-items: flex-start;
    transition: all 0.3s ease;
}

.learning-point-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
}

.point-number {
    background: #4CAF50;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.point-content {
    flex: 1;
}

.point-topic {
    font-size: 16px;
    font-weight: 600;
    color: #4CAF50;
    margin-bottom: 5px;
}

.point-description {
    font-size: 15px;
    line-height: 1.6;
    color: #e0e0e0;
}

.completion-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 25px;
    border-radius: 15px;
    border: 1px solid rgba(76, 175, 80, 0.3);
    text-align: center;
    transition: all 0.3s ease;
}

.stat-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
}

.stat-number {
    font-size: 42px;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #e0e0e0;
    text-transform: uppercase;
    opacity: 0.8;
}

.completion-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}

.completion-actions .continue-button {
    max-width: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.completion-actions .continue-button span {
    font-size: 20px;
}

.completion-actions .menu-return {
    background: linear-gradient(135deg, #2196F3, #1976D2);
}

.completion-actions .menu-return:hover {
    background: linear-gradient(135deg, #1976D2, #2196F3);
}

/* Menu button */
.menu-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    z-index: 100;
}

.menu-button:hover {
    background: rgba(0, 0, 0, 0.5);
}

/* Responsive */
@media (max-width: 1200px) {
    .content-wrapper {
        flex-direction: column;
    }

    .decision-panel {
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .simulator-container {
        width: 100%;
        height: 100vh;
        max-height: none;
        border-radius: 0;
    }

    .header {
        flex-direction: column;
        gap: 10px;
        padding: 10px 15px;
    }

    .title {
        font-size: 16px;
    }

    .vitals-monitor {
        flex-wrap: wrap;
        gap: 10px;
    }

    .menu-header h1 {
        font-size: 32px;
    }

    .scenario-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div class="menu-screen" id="menuScreen">
        <div class="menu-header">
            <h1><img src="images/logo.png" alt="Clinical Simulator Logo" style="width: 40px; height: 40px; vertical-align: middle; margin-right: 8px;"> Clinical Decision Simulator</h1>
            <p>Master critical medical decisions through interactive scenarios</p>
        </div>

        <div class="scenario-grid" id="scenarioGrid">
            <!-- Scenarios will be loaded here -->
        </div>
    </div>

    <!-- Loading screen -->
    <div class="loading-screen" id="loadingScreen" style="display: none;">
        <div class="loading-icon">🚑</div>
        <div class="loading-text">Loading Clinical Scenario...</div>
    </div>

    <!-- Monitor effect -->
    <div class="monitor-lines"></div>
 <button class="menu-button" onclick="backToMenu()">📚 Scenario Menu</button>
    <!-- Main simulator container -->
    <div class="simulator-container" style="display: none;" id="simulatorContainer">


        <div class="header">
            <div class="title">
                <span class="title-icon">🚨</span>
                <span id="scenarioTitle">Emergency Airway Management</span>
            </div>

            <div class="vitals-monitor" id="vitalsMonitor">
                <div class="vital-display">
                    <span class="vital-label">BP</span>
                    <span class="vital-value vital-critical" id="vitalBP">75/40</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">SpO₂</span>
                    <span class="vital-value vital-critical" id="vitalSpO2">85%</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">pH</span>
                    <span class="vital-value vital-critical" id="vitalPH">7.18</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">INR</span>
                    <span class="vital-value vital-warning" id="vitalINR">2.6</span>
                </div>
            </div>

            <div class="score-panel">
                <div class="score-item">
                    <span>✅</span>
                    <span class="score-value" id="correctCount">0</span>
                </div>
                <div class="score-item">
                    <span>📊</span>
                    <span class="score-value" id="stepCount">0</span>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="scenario-panel">
                <div class="patient-header">
                    <div class="patient-info" id="patientInfo">
                        <strong>Patient:</strong> Loading...<br>
                        <strong>Weight:</strong> Loading...<br>
                        <strong>Diagnosis:</strong> Loading...
                    </div>
                </div>

                <div class="clinical-status">
                    <div class="status-title" id="statusTitle">Initial Assessment</div>
                    <div class="current-situation" id="currentSituation">
                        Loading scenario...
                    </div>
                </div>
            </div>

            <div class="decision-panel">
                <h3 class="decision-header">Clinical Decision</h3>
                <div id="decisionsContainer">
                    <!-- Decision options will be inserted here -->
                </div>

                <!-- Decision Path at bottom of right panel -->
                <div class="decision-path-section" id="decisionPathSection">
                    <button class="decision-path-button" onclick="togglePathTracker()">
                        Decision Path <span class="path-toggle-icon">▼</span>
                    </button>
                    <div class="path-history-container collapsed" id="pathHistoryContainer">
                        <div id="pathHistory">
                            <!-- Path history will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback modal -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <div class="feedback-header" id="feedbackHeader">
                <!-- Feedback header will be inserted here -->
            </div>
            <div class="feedback-text" id="feedbackText">
                <!-- Feedback text will be inserted here -->
            </div>
            <div class="reference-box" id="referenceBox" style="display: none;">
                <div class="reference-label">Reference</div>
                <div class="reference-text" id="referenceText" onclick="showReference()"></div>
            </div>
            <div class="outcome-points" id="outcomePoints"></div>
            <button class="continue-button" onclick="continuePath()">Continue</button>
        </div>
    </div>

    <!-- Reference modal -->
    <div class="reference-modal" id="referenceModal">
        <div class="reference-content">
            <div class="reference-header">
                <span id="referenceTitle">Reference Section</span>
                <button class="close-button" onclick="closeReference()">×</button>
            </div>
            <div class="reference-body" id="referenceBody">
                <!-- Reference content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
// Enhanced Clinical Decision Simulator with All Scenarios

// Scenario definitions
const scenarios = {
    'liver-failure': {
        metadata: {
            title: "Acute Liver Failure - Airway Emergency",
            description: "Manage a critically ill patient with acute-on-chronic liver failure requiring emergent intubation",
            specialty: "Critical Care/Emergency Medicine",
            difficulty: "advanced",
            duration: "15-20 min",
            icon: "🫁"
        },
        initial_state: {
            patient: {
                demographics: "52-year-old female",
                weight: "80 kg",
                diagnosis: "Acute-on-chronic liver failure with sepsis"
            },
            vitals: {
                bp: {value: "75/40 mmHg", critical: true},
                spo2: {value: "85%", critical: true},
                ph: {value: "7.18", critical: true},
                inr: {value: "2.6", critical: true}
            }
        },
        nodes: {
            start: {
                type: "scenario",
                title: "Initial Assessment",
                content: "Patient presenting with:\n• Obtunded mental status (GCS 8)\n• Severe hemodynamic instability (SBP 75 mmHg)\n• Significant hypoxemia (SpO₂ 85% on NRB)\n• Severe metabolic acidosis (pH 7.18)\n• Large volume ascites\n• Coagulopathy (INR 2.6)\n\nUrgent airway evaluation required due to deteriorating respiratory status.",
                decisions: [
                    {id: "immediate", text: "Proceed with immediate intubation", next: "immediate_intubation"},
                    {id: "assess", text: "Assess risks and optimize physiology first", next: "assess_risks"},
                    {id: "noninvasive", text: "Trial of noninvasive ventilation", next: "niv_trial"}
                ]
            },
            immediate_intubation: {
                type: "outcome",
                result: "incorrect",
                feedback: "Proceeding without optimization in this high-risk patient significantly increases the risk of peri-intubation cardiac arrest.",
                reference: "Risk Factors",
                points: 0,
                next: "start"
            },
            niv_trial: {
                type: "outcome",
                result: "incorrect",
                feedback: "NIV is contraindicated with obtunded mental status (GCS 8) due to aspiration risk.",
                reference: "NIV Contraindications",
                points: 0,
                next: "start"
            },
            assess_risks: {
                type: "scenario",
                title: "Pre-oxygenation Strategy",
                content: "Risk assessment reveals multiple high-risk factors. Next step: Optimize pre-oxygenation.",
                result: "correct",
                feedback: "Excellent decision! Recognizing and addressing modifiable risk factors before intubation significantly reduces complications.",
                reference: "Risk Factors",
                points: 10,
                decisions: [
                    {id: "standard", text: "Use standard face mask with 100% O₂", next: "standard_mask"},
                    {id: "hfnc", text: "Use high-flow nasal cannula with head of bed elevation", next: "completion"}
                ]
            },
            standard_mask: {
                type: "outcome",
                result: "incorrect",
                feedback: "Standard face masks fail to create a tight seal. HFNC provides superior pre-oxygenation.",
                reference: "Pre-oxygenation Methods",
                points: 0,
                next: "assess_risks"
            },
            completion: {
                type: "completion",
                title: "Case Completed Successfully!",
                summary: "Outstanding management of a high-risk airway!\n\nKey Learning Points:\n1. Risk Stratification: Always optimize physiology before intubation (Risk Factors)\n2. Pre-oxygenation: HFNC provides superior pre-oxygenation in high-risk patients (Pre-oxygenation Methods)\n3. Contraindications: Recognize when NIV is inappropriate (NIV Contraindications)"
            }
        },
        references: {
            "Risk Factors": {
                title: "Risk Factors for Peri-intubation Cardiac Arrest",
                content: "<h3>Major Risk Factors</h3><p>The following factors significantly increase the risk of adverse events during emergency intubation:</p><ul><li><strong>Hypotension:</strong> SBP <90 mmHg (10-fold increased risk)</li><li><strong>Hypoxemia:</strong> SpO₂ <90% despite optimization</li><li><strong>Severe Acidosis:</strong> pH <7.2</li><li><strong>Shock Index >0.9:</strong> HR/SBP ratio indicating hemodynamic instability</li></ul><h3>Risk Modification Strategies</h3><ul><li>Pre-oxygenation with HFNC to improve oxygen reserve</li><li>Hemodynamic support with vasopressors</li><li>Careful medication selection to avoid cardiovascular collapse</li></ul>"
            },
            "NIV Contraindications": {
                title: "Contraindications to Noninvasive Ventilation",
                content: "<h3>Absolute Contraindications</h3><ul><li><strong>Inability to protect airway:</strong> GCS <8, absent gag reflex</li><li><strong>Cardiac or respiratory arrest</strong></li><li><strong>Severe hemodynamic instability</strong></li><li><strong>Facial trauma preventing mask seal</strong></li></ul><h3>Relative Contraindications</h3><ul><li>Agitation or uncooperative patient</li><li>Copious secretions</li><li>Recent upper GI or airway surgery</li></ul>"
            },
            "Pre-oxygenation Methods": {
                title: "Pre-oxygenation in High-Risk Patients",
                content: "<h3>HFNC vs Standard Oxygen Delivery</h3><p>High-flow nasal cannula provides superior pre-oxygenation through:</p><ul><li>Delivery of up to 100% FiO₂</li><li>PEEP effect (3-5 cmH₂O)</li><li>Dead space washout</li><li>Ability to continue during intubation</li></ul><h3>Best Practice Protocol</h3><ol><li>HFNC at 60 L/min, FiO₂ 100%</li><li>Head of bed elevated 20-30°</li><li>Pre-oxygenate for minimum 3 minutes</li><li>Keep HFNC on during intubation</li></ol>"
            }
        }
    },
    'cardiac-arrest': {
        metadata: {
            title: "Cardiac Arrest Protocol",
            description: "Lead a code blue team through ACLS protocols",
            specialty: "Emergency Medicine",
            difficulty: "intermediate",
            duration: "10-15 min",
            icon: "❤️"
        },
        initial_state: {
            patient: {
                demographics: "68-year-old male",
                weight: "85 kg",
                diagnosis: "Witnessed cardiac arrest"
            },
            vitals: {
                bp: {value: "0/0", critical: true},
                hr: {value: "0", critical: true},
                spo2: {value: "0%", critical: true},
                rhythm: {value: "Asystole", critical: true}
            }
        },
        nodes: {
            start: {
                type: "scenario",
                title: "Code Blue Called",
                content: "Patient found unresponsive in hospital bed. No pulse palpable.\n\nCode team has arrived. You are the team leader.",
                decisions: [
                    {id: "cpr", text: "Start CPR immediately", next: "start_cpr"},
                    {id: "pulse", text: "Check for pulse first", next: "check_pulse"},
                    {id: "shock", text: "Prepare defibrillator", next: "prepare_defib"}
                ]
            },
            check_pulse: {
                type: "outcome",
                result: "incorrect",
                feedback: "Delays in starting CPR worsen outcomes. Start CPR immediately if patient is unresponsive.",
                reference: "ACLS Guidelines",
                points: 0,
                next: "start"
            },
            prepare_defib: {
                type: "outcome",
                result: "partial",
                feedback: "While preparing equipment is important, CPR should begin immediately.",
                reference: "ACLS Guidelines",
                points: 5,
                next: "start"
            },
            start_cpr: {
                type: "scenario",
                title: "CPR Initiated",
                content: "High-quality CPR started. Monitor shows asystole.\n\nWhat's your next priority?",
                result: "correct",
                feedback: "Excellent! Immediate CPR is the highest priority in cardiac arrest.",
                reference: "ACLS Guidelines",
                points: 10,
                decisions: [
                    {id: "epi", text: "Administer epinephrine 1mg IV", next: "completion"},
                    {id: "defib", text: "Attempt defibrillation", next: "wrong_rhythm"}
                ]
            },
            wrong_rhythm: {
                type: "outcome",
                result: "incorrect",
                feedback: "Asystole is not a shockable rhythm. Continue CPR and give epinephrine.",
                reference: "Cardiac Rhythms",
                points: 0,
                next: "start_cpr"
            },
            completion: {
                type: "completion",
                title: "Scenario Complete",
                summary: "Good leadership during cardiac arrest!\n\nKey Points:\n1. Immediate CPR: High-quality CPR is the highest priority in cardiac arrest (ACLS Guidelines)\n2. Rhythm Recognition: Distinguish shockable vs non-shockable rhythms (Cardiac Rhythms)\n3. Medication Timing: Early epinephrine for non-shockable rhythms (ACLS Medications)"
            }
        },
        references: {
            "ACLS Guidelines": {
                title: "ACLS Guidelines - High-Quality CPR",
                content: "<h3>Components of High-Quality CPR</h3><ul><li><strong>Rate:</strong> 100-120 compressions/minute</li><li><strong>Depth:</strong> At least 2 inches (5 cm)</li><li><strong>Recoil:</strong> Allow complete chest recoil</li><li><strong>Interruptions:</strong> Minimize (<10 seconds)</li></ul><h3>Priority Actions</h3><ol><li>Start CPR immediately if unresponsive with no normal breathing</li><li>Attach monitor/defibrillator</li><li>Establish IV/IO access</li><li>Give appropriate medications</li></ol>"
            },
            "Cardiac Rhythms": {
                title: "Shockable vs Non-Shockable Rhythms",
                content: "<h3>Shockable Rhythms</h3><ul><li><strong>Ventricular Fibrillation (VF)</strong></li><li><strong>Pulseless Ventricular Tachycardia (pVT)</strong></li></ul><h3>Non-Shockable Rhythms</h3><ul><li><strong>Asystole:</strong> No electrical activity</li><li><strong>PEA:</strong> Organized electrical activity without pulse</li></ul><p style='background: rgba(255, 68, 68, 0.2); padding: 10px; border-radius: 5px;'><strong>Remember:</strong> Never shock asystole or PEA!</p>"
            },
            "ACLS Medications": {
                title: "ACLS Medication Protocol",
                content: "<h3>Epinephrine</h3><ul><li><strong>Dose:</strong> 1 mg IV/IO every 3-5 minutes</li><li><strong>Mechanism:</strong> α and β adrenergic effects</li><li><strong>Timing:</strong> As soon as possible for non-shockable rhythms</li></ul><h3>Amiodarone</h3><ul><li><strong>Dose:</strong> 300 mg IV/IO for first dose, 150 mg for second</li><li><strong>Use:</strong> VF/pVT after 3 shocks</li></ul>"
            }
        }
    },
    'sepsis-bundle': {
        metadata: {
            title: "Sepsis Recognition & Bundle",
            description: "Identify and manage severe sepsis/septic shock",
            specialty: "Critical Care",
            difficulty: "basic",
            duration: "10-12 min",
            icon: "🦠"
        },
        initial_state: {
            patient: {
                demographics: "72-year-old female",
                weight: "70 kg",
                diagnosis: "Suspected urosepsis"
            },
            vitals: {
                bp: {value: "85/50", critical: true},
                hr: {value: "118", critical: true},
                temp: {value: "38.9°C", critical: true},
                rr: {value: "26", critical: true}
            }
        },
        nodes: {
            start: {
                type: "scenario",
                title: "ED Presentation",
                content: "Patient presents with:\n• Fever and confusion\n• Hypotension despite 1L fluid\n• Tachycardia and tachypnea\n• Suspected UTI source\n\nWhat's your immediate priority?",
                decisions: [
                    {id: "bundle", text: "Initiate sepsis bundle", next: "sepsis_bundle"},
                    {id: "fluids", text: "Give more IV fluids only", next: "fluids_only"},
                    {id: "cultures", text: "Obtain cultures first", next: "cultures_first"}
                ]
            },
            fluids_only: {
                type: "outcome",
                result: "partial",
                feedback: "Fluids are important but antibiotics within 1 hour significantly reduce mortality.",
                reference: "Sepsis Bundle",
                points: 5,
                next: "start"
            },
            cultures_first: {
                type: "outcome",
                result: "incorrect",
                feedback: "While cultures are important, don't delay antibiotics. Draw cultures and give antibiotics together.",
                reference: "Antibiotic Timing",
                points: 0,
                next: "start"
            },
            sepsis_bundle: {
                type: "scenario",
                title: "Sepsis Bundle Initiated",
                content: "Bundle components started:\n• Blood cultures drawn\n• Lactate sent\n• Broad-spectrum antibiotics ordered\n• Fluid resuscitation ongoing\n\nLactate returns at 4.2. What's next?",
                result: "correct",
                feedback: "Perfect! Early bundle compliance improves survival in sepsis.",
                reference: "Sepsis Bundle",
                points: 10,
                decisions: [
                    {id: "pressors", text: "Start vasopressors for MAP <65", next: "completion"},
                    {id: "more_fluids", text: "Continue fluids to 30 mL/kg", next: "completion"}
                ]
            },
            completion: {
                type: "completion",
                title: "Sepsis Management Complete",
                summary: "Well done managing septic shock!\n\nKey Learning:\n1. Early Recognition: SIRS criteria and organ dysfunction indicate sepsis (Sepsis Criteria)\n2. Bundle Compliance: Complete all elements within 1 hour (Sepsis Bundle)\n3. Time-Critical Antibiotics: Every hour delay increases mortality (Antibiotic Timing)\n4. Lactate Monitoring: Serial lactate guides resuscitation (Lactate Clearance)"
            }
        },
        references: {
            "Sepsis Criteria": {
                title: "Sepsis Recognition Criteria",
                content: "<h3>SIRS Criteria (≥2 required)</h3><ul><li>Temperature >38°C or <36°C</li><li>Heart rate >90 bpm</li><li>Respiratory rate >20 or PaCO2 <32</li><li>WBC >12,000 or <4,000 or >10% bands</li></ul><h3>Organ Dysfunction Signs</h3><ul><li>Hypotension: SBP <90 or MAP <65</li><li>Lactate >2 mmol/L</li><li>Creatinine >2.0 or urine output <0.5 mL/kg/hr</li><li>Bilirubin >2 mg/dL</li><li>Platelet count <100,000</li></ul>"
            },
            "Sepsis Bundle": {
                title: "Sepsis Bundle Components",
                content: "<h3>Within 1 Hour</h3><ol><li><strong>Measure lactate level</strong></li><li><strong>Obtain blood cultures</strong> before antibiotics</li><li><strong>Administer broad-spectrum antibiotics</strong></li><li><strong>Begin rapid fluid resuscitation</strong> (30 mL/kg crystalloid for hypotension or lactate ≥4)</li><li><strong>Apply vasopressors</strong> if hypotensive during or after fluid resuscitation</li></ol><p style='background: rgba(76, 175, 80, 0.2); padding: 10px; border-radius: 5px;'><strong>Remember:</strong> The 1-hour bundle is the standard of care for sepsis management.</p>"
            },
            "Antibiotic Timing": {
                title: "Antibiotic Administration in Sepsis",
                content: "<h3>Time is Life</h3><p style='background: rgba(255, 68, 68, 0.2); padding: 10px; border-radius: 5px;'>Each hour delay in antibiotic administration is associated with 7.6% increase in mortality</p><h3>Empiric Coverage</h3><ul><li>Cover likely pathogens based on source</li><li>Consider local resistance patterns</li><li>Include MRSA coverage if risk factors</li><li>Add antifungal if immunocompromised</li></ul>"
            },
            "Lactate Clearance": {
                title: "Lactate as a Resuscitation Marker",
                content: "<h3>Lactate Interpretation</h3><ul><li><strong>Normal:</strong> <2 mmol/L</li><li><strong>Elevated:</strong> 2-4 mmol/L (increased mortality)</li><li><strong>Severe:</strong> >4 mmol/L (high mortality risk)</li></ul><h3>Lactate Clearance Goals</h3><ul><li>Repeat lactate if initial elevated</li><li>Target: ≥10% decrease in 2-4 hours</li><li>Normalize within 6 hours if possible</li></ul>"
            }
        }
    }
};

// Clinical Simulator Class
class ClinicalSimulator {
    constructor() {
        this.currentScenario = null;
        this.currentNode = 'start';
        this.pathHistory = [];
        this.correctDecisions = 0;
        this.totalDecisions = 0;
        this.score = 0;
        this.currentReference = null;
    }

    loadScenario(scenarioId) {
        this.currentScenario = scenarios[scenarioId];
        this.currentNode = 'start';
        this.pathHistory = [];
        this.correctDecisions = 0;
        this.totalDecisions = 0;
        this.score = 0;

        // Update UI elements
        document.getElementById('scenarioTitle').textContent = this.currentScenario.metadata.title;

        // Update patient info
        const patient = this.currentScenario.initial_state.patient;
        document.getElementById('patientInfo').innerHTML = `
            <strong>Patient:</strong> ${patient.demographics}<br>
            <strong>Weight:</strong> ${patient.weight}<br>
            <strong>Diagnosis:</strong> ${patient.diagnosis}
        `;

        // Update initial vitals
        this.updateVitals(this.currentScenario.initial_state.vitals);
    }

    getCurrentNode() {
        return this.currentScenario.nodes[this.currentNode];
    }

    makeDecision(decisionId) {
        const node = this.getCurrentNode();
        const decision = node.decisions.find(d => d.id === decisionId);

        if (!decision) return null;

        const nextNode = this.currentScenario.nodes[decision.next];

        // Record decision
        this.pathHistory.push({
            nodeId: decision.next,
            nodeTitle: nextNode.title || decision.text,
            decision: decision.text,
            result: nextNode.result || 'neutral',
            feedback: nextNode.feedback,
            reference: nextNode.reference
        });

        // Update tracking
        this.totalDecisions++;
        if (nextNode.result === 'correct') {
            this.correctDecisions++;
        }

        // Handle scoring
        if (nextNode.points) {
            this.score += nextNode.points;
        }

        // Prepare result
        const result = {
            type: nextNode.type,
            result: nextNode.result,
            feedback: nextNode.feedback,
            reference: nextNode.reference,
            points: nextNode.points || 0,
            nextNodeId: decision.next,
            actualNextNode: nextNode.next
        };

        // Update current node for scenario types
        if (nextNode.type === 'scenario') {
            this.currentNode = decision.next;
        }

        return result;
    }

    updateVitals(vitals) {
        // Update BP
        if (vitals.bp) {
            document.getElementById('vitalBP').textContent = vitals.bp.value;
            document.getElementById('vitalBP').className = vitals.bp.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        // Update SpO2
        if (vitals.spo2) {
            document.getElementById('vitalSpO2').textContent = vitals.spo2.value;
            document.getElementById('vitalSpO2').className = vitals.spo2.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        // Update pH
        if (vitals.ph) {
            document.getElementById('vitalPH').textContent = vitals.ph.value;
            document.getElementById('vitalPH').className = vitals.ph.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        // Update INR
        if (vitals.inr) {
            document.getElementById('vitalINR').textContent = vitals.inr.value;
            document.getElementById('vitalINR').className = vitals.inr.critical ? 'vital-value vital-warning' : 'vital-value vital-normal';
        }
        // Update other vitals as needed
        if (vitals.hr) {
            document.getElementById('vitalBP').textContent = vitals.bp?.value || vitals.hr.value + ' bpm';
        }
        if (vitals.temp) {
            document.getElementById('vitalINR').textContent = vitals.temp.value;
        }
    }
}

// UI Controller
class SimulatorUI {
    constructor() {
        this.simulator = new ClinicalSimulator();
        this.feedbackCallback = null;
    }

    init() {
        this.showMenu();
    }

    showMenu() {
        document.getElementById('menuScreen').style.display = 'flex';
        document.getElementById('simulatorContainer').style.display = 'none';
        document.getElementById('loadingScreen').style.display = 'none';

        const grid = document.getElementById('scenarioGrid');
        grid.innerHTML = '';

        // Display available scenarios
        Object.keys(scenarios).forEach((scenarioId, index) => {
            const scenario = scenarios[scenarioId];
            const card = document.createElement('div');
            card.className = 'scenario-card';
            card.style.animationDelay = `${index * 0.1}s`;

            card.innerHTML = `
                <div class="scenario-icon">${scenario.metadata.icon}</div>
                <h3 class="scenario-title">${scenario.metadata.title}</h3>
                <div class="scenario-meta">
                    <span>⏱️ ${scenario.metadata.duration}</span>
                    <span class="difficulty-${scenario.metadata.difficulty}">
                        📊 ${scenario.metadata.difficulty}
                    </span>
                </div>
                <p class="scenario-description">${scenario.metadata.description}</p>
            `;

            card.onclick = () => this.startScenario(scenarioId);
            grid.appendChild(card);
        });

        // Add coming soon cards
        const comingSoon = [
            {icon: "🧠", title: "Acute Stroke Management", difficulty: "intermediate"},
            {icon: "🚑", title: "Trauma Airway", difficulty: "advanced"},
            {icon: "👶", title: "Pediatric Resuscitation", difficulty: "intermediate"}
        ];

        comingSoon.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'scenario-card coming-soon';
            card.style.animationDelay = `${(Object.keys(scenarios).length + index) * 0.1}s`;

            card.innerHTML = `
                <div class="scenario-icon">${item.icon}</div>
                <h3 class="scenario-title">${item.title}</h3>
                <div class="scenario-meta">
                    <span class="difficulty-${item.difficulty}">Coming Soon</span>
                </div>
            `;

            grid.appendChild(card);
        });
    }

    startScenario(scenarioId) {
        // Show loading screen
        document.getElementById('menuScreen').style.display = 'none';
        document.getElementById('loadingScreen').style.display = 'flex';

        setTimeout(() => {
            this.simulator.loadScenario(scenarioId);
            this.updateDisplay();

            // Hide loading and show simulator
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('simulatorContainer').style.display = 'flex';
        }, 1500);
    }

    updateDisplay() {
        const node = this.simulator.getCurrentNode();

        if (!node) return;

        // Handle different node types
        switch (node.type) {
            case 'scenario':
                this.displayScenario(node);
                break;
            case 'completion':
                this.displayCompletion(node);
                break;
        }

        // Update scores
        this.updateScores();

        // Update path history
        this.updatePathHistory();
    }

    displayScenario(node) {
        // Update title and content
        document.getElementById('statusTitle').textContent = node.title || 'Clinical Situation';
        document.getElementById('currentSituation').innerHTML = node.content.replace(/\n/g, '<br>');

        // Update vitals if specified
        if (node.vitals_update) {
            this.simulator.updateVitals(node.vitals_update);
        }

        // Display decisions
        const container = document.getElementById('decisionsContainer');
        container.innerHTML = '';

        if (node.decisions && node.decisions.length > 0) {
            node.decisions.forEach((decision, index) => {
                const button = document.createElement('div');
                button.className = 'decision-button';
                button.innerHTML = `
                    <div class="decision-label">Option ${index + 1}</div>
                    <div class="decision-text">${decision.text}</div>
                `;
                button.onclick = () => this.makeDecision(decision.id);
                container.appendChild(button);
            });
        }
    }

    async makeDecision(decisionId) {
        const result = this.simulator.makeDecision(decisionId);

        if (!result) return;

        // Show feedback
        await this.showFeedback(result);

        // Handle next action
        if (result.type === 'outcome') {
            // For outcome nodes, move to the next node
            if (result.actualNextNode) {
                this.simulator.currentNode = result.actualNextNode;
                this.updateDisplay();
            }
        } else if (result.type === 'scenario') {
            // For scenario nodes, we're already at the next node
            this.updateDisplay();
        } else if (result.type === 'completion') {
            // Show completion
            this.simulator.currentNode = result.nextNodeId;
            this.updateDisplay();
        }
    }

    showFeedback(result) {
        return new Promise((resolve) => {
            const modal = document.getElementById('feedbackModal');
            const header = document.getElementById('feedbackHeader');
            const text = document.getElementById('feedbackText');
            const refBox = document.getElementById('referenceBox');
            const refText = document.getElementById('referenceText');
            const points = document.getElementById('outcomePoints');

            // Set feedback content
            let icon, className, title;
            if (result.result === 'correct') {
                icon = '✅';
                className = 'feedback-correct';
                title = 'Correct Decision!';
            } else if (result.result === 'partial') {
                icon = '⚠️';
                className = 'feedback-partial';
                title = 'Partially Correct';
            } else {
                icon = '❌';
                className = 'feedback-incorrect';
                title = 'Incorrect Decision';
            }

            header.className = `feedback-header ${className}`;
            header.innerHTML = `<span class="feedback-icon">${icon}</span> ${title}`;
            text.textContent = result.feedback || '';

            // Show reference if available
            if (result.reference) {
                // Store the current scenario for reference lookup
                this.simulator.currentReference = result.reference;

                const reference = this.simulator.currentScenario.references?.[result.reference];
                if (reference) {
                    refBox.style.display = 'block';
                    refText.textContent = result.reference;
                } else {
                    console.warn('Reference not found:', result.reference);
                    refBox.style.display = 'none';
                }
            } else {
                refBox.style.display = 'none';
            }

            // Show points
            points.innerHTML = `Points earned: <strong>${result.points}</strong>`;

            // Set up continue callback
            this.feedbackCallback = () => {
                modal.style.display = 'none';
                resolve();
            };

            // Show modal
            modal.style.display = 'flex';
        });
    }

    displayCompletion(node) {
        const scenarioPanel = document.querySelector('.scenario-panel');
        const decisionPanel = document.querySelector('.decision-panel');

        const totalPossibleScore = 30; // You can calculate this dynamically
        const percentage = Math.round((this.simulator.score / totalPossibleScore) * 100);

        // Format the summary text with better structure
        let formattedSummary = node.summary;

        // Check if summary contains key learning points
        if (formattedSummary.includes('Key Learning Points:') || formattedSummary.includes('Key Points:')) {
            const parts = formattedSummary.split(/Key (?:Learning )?Points:/i);
            const introText = parts[0].trim();
            const learningSection = parts[1] ? parts[1].trim() : '';

            // Parse numbered items
            const points = learningSection.split(/\d+\.\s+/).filter(p => p.trim());

            formattedSummary = `
                <div class="completion-intro">${introText.replace(/\n/g, '<br>')}</div>
                <div class="learning-points-section">
                    <h3 class="learning-points-title">Key Learning Points</h3>
                    <div class="learning-points-list">
            `;

            points.forEach((point, index) => {
                // Extract reference from parentheses
                const refMatch = point.match(/\(([^)]+)\)$/);
                let reference = null;
                let cleanPoint = point;

                if (refMatch) {
                    reference = refMatch[1];
                    cleanPoint = point.replace(/\s*\([^)]+\)$/, '').trim();
                }

                // Check if point has a topic: description format
                const colonIndex = cleanPoint.indexOf(':');
                if (colonIndex > 0 && colonIndex < 50) { // Reasonable position for a topic
                    const topic = cleanPoint.substring(0, colonIndex).trim();
                    const description = cleanPoint.substring(colonIndex + 1).trim();
                    formattedSummary += `
                        <div class="learning-point-item">
                            <div class="point-number">${index + 1}</div>
                            <div class="point-content">
                                <div class="point-topic">${topic}</div>
                                <div class="point-description">
                                    ${description}
                                    ${reference ? `<a class="reference-link" onclick="simulatorUI.showReferenceFromCompletion('${reference}')">(${reference})</a>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    formattedSummary += `
                        <div class="learning-point-item">
                            <div class="point-number">${index + 1}</div>
                            <div class="point-content">
                                <div class="point-description">
                                    ${cleanPoint}
                                    ${reference ? `<a class="reference-link" onclick="simulatorUI.showReferenceFromCompletion('${reference}')">(${reference})</a>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            formattedSummary += `
                    </div>
                </div>
            `;
        } else {
            formattedSummary = `<div class="completion-summary">${formattedSummary.replace(/\n/g, '<br>')}</div>`;
        }

        const completionHTML = `
            <div class="completion-screen">
                <div class="completion-title">
                    <span class="completion-icon">🎉</span>
                    ${node.title || 'Scenario Complete!'}
                </div>

                ${formattedSummary}

                <div class="completion-stats">
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.score}</div>
                        <div class="stat-label">Total Score</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${percentage}%</div>
                        <div class="stat-label">Performance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.correctDecisions}</div>
                        <div class="stat-label">Correct Decisions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.totalDecisions}</div>
                        <div class="stat-label">Total Decisions</div>
                    </div>
                </div>

                <div class="completion-actions">
                    <button class="continue-button" onclick="location.reload()">
                        <span>🔄</span> Try Another Scenario
                    </button>
                    <button class="continue-button menu-return" onclick="simulatorUI.showMenu()">
                        <span>📚</span> Back to Menu
                    </button>
                </div>
            </div>
        `;

        // Replace scenario panel content
        scenarioPanel.innerHTML = completionHTML;

        // Hide decision panel
        decisionPanel.style.display = 'none';
    }

    showReferenceFromCompletion(referenceKey) {
        const reference = this.simulator.currentScenario.references?.[referenceKey];
        if (!reference) {
            console.error('Reference not found:', referenceKey);
            return;
        }

        const modal = document.getElementById('referenceModal');
        const title = document.getElementById('referenceTitle');
        const body = document.getElementById('referenceBody');

        title.textContent = reference.title;
        body.innerHTML = reference.content;

        modal.style.display = 'flex';
    }

    updateScores() {
        document.getElementById('correctCount').textContent = this.simulator.correctDecisions;
        document.getElementById('stepCount').textContent = this.simulator.totalDecisions;
    }

    updatePathHistory() {
        const container = document.getElementById('pathHistory');
        container.innerHTML = '';

        this.simulator.pathHistory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `path-item ${item.result || ''}`;

            div.innerHTML = `
                <strong>Step ${index + 1}:</strong> ${item.decision}
                ${item.result !== 'neutral' ? `<div class="path-result ${item.result}">→ ${item.result}</div>` : ''}
            `;

            div.onclick = () => this.showPathReview(item);
            container.appendChild(div);
        });
    }

    showPathReview(pathItem) {
        const modal = document.getElementById('feedbackModal');
        const header = document.getElementById('feedbackHeader');
        const text = document.getElementById('feedbackText');
        const refBox = document.getElementById('referenceBox');

        header.className = `feedback-header feedback-${pathItem.result}`;
        header.innerHTML = `Review: ${pathItem.nodeTitle}`;
        text.innerHTML = `<strong>Your Choice:</strong> ${pathItem.decision}<br><br>${pathItem.feedback || 'No feedback available.'}`;

        if (pathItem.reference) {
            refBox.style.display = 'block';
            document.getElementById('referenceText').textContent = pathItem.reference;
            this.simulator.currentReference = pathItem.reference;
        } else {
            refBox.style.display = 'none';
        }

        modal.style.display = 'flex';
    }
}

// Global instance
const simulatorUI = new SimulatorUI();

// Global functions
function continuePath() {
    if (simulatorUI.feedbackCallback) {
        simulatorUI.feedbackCallback();
    }
}

function togglePathTracker() {
    const container = document.getElementById('pathHistoryContainer');
    const icon = document.querySelector('.path-toggle-icon');
    container.classList.toggle('collapsed');
    icon.textContent = container.classList.contains('collapsed') ? '▼' : '▲';
}

function showReference() {
    // Get the current reference from the simulator
    const referenceKey = simulatorUI.simulator.currentReference;
    if (!referenceKey) {
        console.error('No reference key set');
        return;
    }

    const reference = simulatorUI.simulator.currentScenario.references?.[referenceKey];
    if (!reference) {
        console.error('Reference not found:', referenceKey);
        return;
    }

    const modal = document.getElementById('referenceModal');
    const title = document.getElementById('referenceTitle');
    const body = document.getElementById('referenceBody');

    title.textContent = reference.title;
    body.innerHTML = reference.content;

    modal.style.display = 'flex';
}

function closeReference() {
    document.getElementById('referenceModal').style.display = 'none';
}

function backToMenu() {
    location.reload(); // Simple way to return to menu
}

// Keyboard shortcuts
document.addEventListener('keypress', (e) => {
    const num = parseInt(e.key);
    if (num >= 1 && num <= 9) {
        const buttons = document.querySelectorAll('.decision-button');
        if (buttons[num - 1]) {
            buttons[num - 1].click();
        }
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeReference();
        const feedbackModal = document.getElementById('feedbackModal');
        if (feedbackModal.style.display === 'flex') {
            continuePath();
        }
    }
});

// Initialize on load
window.onload = function() {
    simulatorUI.init();
};
    </script>
</body>
</html>