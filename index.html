<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinical Decision Simulator</title>
    <style>
/* Clinical Decision Simulator - Complete Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

/* Medical monitor effect */
.monitor-lines {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.02;
    background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 0, 0.1) 2px,
        rgba(0, 255, 0, 0.1) 4px
    );
    pointer-events: none;
    z-index: 0;
}

/* Loading screen */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #1a1a2e;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    transition: opacity 0.5s ease;
}

.loading-icon {
    font-size: 48px;
    animation: pulse 1.5s ease infinite;
    margin-bottom: 20px;
}

.loading-text {
    font-size: 20px;
    color: #4CAF50;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

/* Main container */
.simulator-container {
    position: relative;
    z-index: 1;
    width: 95%;
    max-width: 1400px;
    height: 90vh;
    max-height: 900px;
    background: rgba(30, 30, 45, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Header with vitals */
.header {
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.9), rgba(139, 0, 0, 0.9));
    padding: 15px 25px;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    flex-wrap: nowrap;
}

.title {
    font-size: 22px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.title-icon {
    font-size: 26px;
}

/* Vital signs monitor */
.vitals-monitor, #vitalsMonitor {
    display: flex !important;
    flex-direction: row !important;
    gap: 15px;
    align-items: center;
    background: rgba(0, 0, 0, 0.3);
    padding: 10px 20px;
    border-radius: 10px;
}

.vital-display {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    gap: 8px;
    padding: 0 15px;
    border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.vital-display:last-child {
    border-right: none;
}

.vital-label {
    font-size: 12px;
    text-transform: uppercase;
    opacity: 0.7;
    font-weight: 600;
    display: inline-block;
}

.vital-value {
    font-size: 18px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    white-space: nowrap;
    display: inline-block;
}

.vital-critical {
    color: #ff4444;
    animation: pulse 1s ease-in-out infinite;
}

.vital-warning {
    color: #ffaa00;
}

.vital-normal {
    color: #44ff44;
}

/* Score tracking */
.score-panel {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 20px;
    border-radius: 10px;
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: center;
    flex-shrink: 0;
}

.score-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.score-value {
    font-size: 18px;
    font-weight: bold;
    color: #4CAF50;
}

/* Main content area */
.content-wrapper {
    flex: 1;
    display: flex;
    gap: 20px;
    padding: 20px;
    overflow: hidden;
}

/* Clinical scenario panel */
.scenario-panel {
    flex: 2;
    background: rgba(40, 40, 60, 0.6);
    border-radius: 15px;
    padding: 25px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.patient-header {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.patient-info {
    font-size: 16px;
    line-height: 1.6;
}

.clinical-status {
    margin-top: 20px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border-left: 4px solid #ff4444;
}

.status-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #ff4444;
}

.current-situation {
    font-size: 15px;
    line-height: 1.8;
    color: #e0e0e0;
}

/* Decision panel */
.decision-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    position: relative;
}

.decision-header {
    font-size: 18px;
    font-weight: 600;
    color: #4CAF50;
    margin-bottom: 10px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#decisionsContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto;
}

/* Decision Path Section */
.decision-path-section {
    margin-top: auto;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 15px;
}

.decision-path-button {
    width: 100%;
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4CAF50;
    color: #4CAF50;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
}

.decision-path-button:hover {
    background: rgba(76, 175, 80, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.path-toggle-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.path-history-container {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 15px;
    transition: max-height 0.3s ease;
}

.path-history-container.collapsed {
    max-height: 0;
    overflow: hidden;
}

.decision-button {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
    border: 2px solid rgba(76, 175, 80, 0.3);
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.decision-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.2), transparent);
    transition: left 0.5s ease;
}

.decision-button:hover {
    border-color: #4CAF50;
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
}

.decision-button:hover::before {
    left: 100%;
}

.decision-label {
    font-size: 14px;
    color: #4CAF50;
    text-transform: uppercase;
    margin-bottom: 8px;
    font-weight: 600;
}

.decision-text {
    font-size: 15px;
    color: #e0e0e0;
    line-height: 1.5;
}

/* Path history items */
.path-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    font-size: 13px;
    border-left: 3px solid #666;
    background: rgba(100, 100, 100, 0.1);
    transition: all 0.3s ease;
    animation: slideInLeft 0.3s ease;
    cursor: pointer;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.path-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.path-item.correct {
    border-left-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.path-item.incorrect {
    border-left-color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
}

.path-item.partial {
    border-left-color: #ffaa00;
    background: rgba(255, 170, 0, 0.1);
}

.path-result {
    font-size: 11px;
    margin-top: 5px;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Feedback modal */
.feedback-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.feedback-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 15px;
    padding: 30px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid rgba(255, 255, 255, 0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.feedback-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 600;
}

.feedback-correct {
    color: #4CAF50;
}

.feedback-incorrect {
    color: #ff4444;
}

.feedback-partial {
    color: #ffaa00;
}

.feedback-icon {
    font-size: 36px;
}

.feedback-text {
    font-size: 16px;
    line-height: 1.8;
    color: #e0e0e0;
    margin-bottom: 15px;
}

.reference-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #2196F3;
}

.reference-label {
    font-size: 12px;
    text-transform: uppercase;
    color: #2196F3;
    margin-bottom: 5px;
}

.reference-text {
    font-size: 14px;
    color: #e0e0e0;
    cursor: pointer;
    text-decoration: underline;
    transition: color 0.3s ease;
}

.reference-text:hover {
    color: #4CAF50;
}

/* Reference modal */
.reference-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.reference-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 15px;
    padding: 40px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #2196F3;
    animation: slideIn 0.3s ease;
}

.reference-header {
    font-size: 24px;
    color: #2196F3;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-button {
    font-size: 28px;
    color: #e0e0e0;
    cursor: pointer;
    transition: color 0.3s ease;
    background: none;
    border: none;
}

.close-button:hover {
    color: #ff4444;
}

.reference-body {
    font-size: 16px;
    line-height: 1.8;
    color: #e0e0e0;
}

.reference-body h3 {
    color: #4CAF50;
    margin-top: 20px;
    margin-bottom: 10px;
}

.reference-body ul {
    margin-left: 20px;
    margin-bottom: 15px;
}

.reference-body li {
    margin-bottom: 8px;
}

.reference-body strong {
    color: #4CAF50;
}

.reference-body table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
}

.reference-body th, .reference-body td {
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    text-align: left;
}

.reference-body th {
    background: rgba(33, 150, 243, 0.2);
}

.outcome-points {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-size: 18px;
    margin-bottom: 15px;
}

.continue-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.continue-button:hover {
    background: linear-gradient(135deg, #45a049, #4CAF50);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
}

/* Completion screen */
.completion-screen {
    text-align: center;
    padding: 40px;
}

.completion-title {
    font-size: 32px;
    color: #4CAF50;
    margin-bottom: 20px;
}

.completion-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.stat-number {
    font-size: 36px;
    font-weight: bold;
    color: #4CAF50;
}

.stat-label {
    font-size: 14px;
    color: #e0e0e0;
    text-transform: uppercase;
    margin-top: 5px;
}

/* Menu button */
.menu-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    z-index: 100;
}

.menu-button:hover {
    background: rgba(0, 0, 0, 0.5);
}

/* Responsive */
@media (max-width: 1200px) {
    .content-wrapper {
        flex-direction: column;
    }

    .decision-panel {
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .simulator-container {
        width: 100%;
        height: 100vh;
        max-height: none;
        border-radius: 0;
    }

    .header {
        flex-direction: column;
        gap: 10px;
        padding: 10px 15px;
    }

    .title {
        font-size: 16px;
    }

    .vitals-monitor {
        flex-wrap: wrap;
        gap: 10px;
    }
}
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon">🚑</div>
        <div class="loading-text">Loading Clinical Scenario...</div>
    </div>
    <div class="return-to-menu-panel">
                    <button class="menu-button" onclick="backToMenu()">📚 Scenario Menu</button>
                </div>

    <!-- Monitor effect -->
    <div class="monitor-lines"></div>

    <!-- Main simulator container -->
    <!-- Add this inside the simulator-container, right after the opening div -->
<!--  <button class="menu-button" onclick="window.location.href='scenario-menu.html'">📚 Scenario Menu</button>-->
    <div class="simulator-container" style="display: none;" id="simulatorContainer">


        <div class="header">
            <div class="title">
                <span class="title-icon">🚨</span>
                <span id="scenarioTitle">Emergency Airway Management</span>
            </div>

            <div class="vitals-monitor" id="vitalsMonitor">
                <div class="vital-display">
                    <span class="vital-label">BP</span>
                    <span class="vital-value vital-critical" id="vitalBP">75/40</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">SpO₂</span>
                    <span class="vital-value vital-critical" id="vitalSpO2">85%</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">pH</span>
                    <span class="vital-value vital-critical" id="vitalPH">7.18</span>
                </div>
                <div class="vital-display">
                    <span class="vital-label">INR</span>
                    <span class="vital-value vital-warning" id="vitalINR">2.6</span>
                </div>
            </div>

            <div class="score-panel">
                <div class="score-item" data-icon="✅">
                    <span class="score-label-text">Correct:</span>
                    <span class="score-value" id="correctCount">0</span></div>
                    <div class="score-item" data-icon="📊">
                        <span class="score-label-text">Steps:</span>
                        <span class="score-value" id="stepCount">0</span>
                     </div>

                 </div>


        </div>

        <div class="content-wrapper">
            <div class="scenario-panel">
                <div class="patient-header">
                    <div class="patient-info" id="patientInfo">
                        <strong>Patient:</strong> 52-year-old female<br>
                        <strong>Weight:</strong> 80 kg<br>
                        <strong>Diagnosis:</strong> Acute-on-chronic liver failure with sepsis
                    </div>
                </div>


                <div class="clinical-status">
                    <div class="status-title" id="statusTitle">Initial Assessment</div>
                    <div class="current-situation" id="currentSituation">
                        Patient presenting with:<br>
                        • Obtunded mental status<br>
                        • Severe hemodynamic instability (SBP 75 mmHg)<br>
                        • Significant hypoxemia (SpO₂ 85%)<br>
                        • Severe metabolic acidosis (pH 7.18)<br>
                        • Large volume ascites<br>
                        • Coagulopathy (INR 2.6)<br><br>
                        Urgent airway evaluation required due to deteriorating respiratory status.
                    </div>
                </div>
            </div>

            <div class="decision-panel">
                <h3 class="decision-header">Clinical Decision</h3>
                <div id="decisionsContainer">
                    <!-- Decision options will be inserted here -->
                </div>

                <!-- Decision Path at bottom of right panel -->
                <div class="decision-path-section" id="decisionPathSection">
                    <button class="decision-path-button" onclick="togglePathTracker()">
                        Decision Path <span class="path-toggle-icon">▼</span>
                    </button>
                    <div class="path-history-container collapsed" id="pathHistoryContainer">
                        <div id="pathHistory">
                            <!-- Path history will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback modal -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <div class="feedback-header" id="feedbackHeader">
                <!-- Feedback header will be inserted here -->
            </div>
            <div class="feedback-text" id="feedbackText">
                <!-- Feedback text will be inserted here -->
            </div>
            <div class="reference-box" id="referenceBox" style="display: none;">
                <div class="reference-label">Reference</div>
                <div class="reference-text" id="referenceText" onclick="showReference()"></div>
            </div>
            <div class="outcome-points" id="outcomePoints"></div>
            <button class="continue-button" onclick="continuePath()">Continue</button>
        </div>
    </div>

    <!-- Reference modal -->
    <div class="reference-modal" id="referenceModal">
        <div class="reference-content">
            <div class="reference-header">
                <span id="referenceTitle">Reference Section</span>
                <button class="close-button" onclick="closeReference()">×</button>
            </div>
            <div class="reference-body" id="referenceBody">
                <!-- Reference content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
// Clinical Decision Simulator - Complete JavaScript
class ClinicalSimulator {
    constructor() {
        this.scenarioData = null;
        this.currentNode = 'start';
        this.pathHistory = [];
        this.correctDecisions = 0;
        this.totalDecisions = 0;
        this.score = 0;
        this.currentReference = null;
    }

    loadScenario(scenarioData) {
        this.scenarioData = scenarioData;
        this.currentNode = 'start';
        this.pathHistory = [];
        this.correctDecisions = 0;
        this.totalDecisions = 0;
        this.score = 0;

        // Update title
        document.getElementById('scenarioTitle').textContent = scenarioData.metadata.title;

        // Update patient info
        const patient = scenarioData.initial_state.patient;
        document.getElementById('patientInfo').innerHTML = `
            <strong>Patient:</strong> ${patient.demographics}<br>
            <strong>Weight:</strong> ${patient.weight}<br>
            <strong>Diagnosis:</strong> ${patient.diagnosis}
        `;

        // Update initial vitals
        this.updateVitals(scenarioData.initial_state.vitals);
    }

    getCurrentNode() {
        return this.scenarioData.nodes[this.currentNode];
    }

    makeDecision(decisionId) {
        const node = this.getCurrentNode();
        const decision = node.decisions.find(d => d.id === decisionId);

        if (!decision) return null;

        const nextNode = this.scenarioData.nodes[decision.next];

        // Record decision
        this.pathHistory.push({
            nodeId: decision.next,
            nodeTitle: nextNode.title || decision.text,
            decision: decision.text,
            result: nextNode.result || 'neutral',
            feedback: nextNode.feedback,
            reference: nextNode.reference
        });

        // Update tracking
        this.totalDecisions++;
        if (nextNode.result === 'correct') {
            this.correctDecisions++;
        }

        // Handle scoring
        if (nextNode.points) {
            this.score += nextNode.points;
        }

        // Prepare result
        const result = {
            type: nextNode.type,
            result: nextNode.result,
            feedback: nextNode.feedback,
            reference: nextNode.reference,
            points: nextNode.points || 0,
            nextNodeId: decision.next,
            actualNextNode: nextNode.next
        };

        // Update current node for scenario types
        if (nextNode.type === 'scenario') {
            this.currentNode = decision.next;
        }

        return result;
    }

    updateVitals(vitals) {
        if (vitals.bp) {
            document.getElementById('vitalBP').textContent = vitals.bp.value;
            document.getElementById('vitalBP').className = vitals.bp.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        if (vitals.spo2) {
            document.getElementById('vitalSpO2').textContent = vitals.spo2.value;
            document.getElementById('vitalSpO2').className = vitals.spo2.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        if (vitals.ph) {
            document.getElementById('vitalPH').textContent = vitals.ph.value;
            document.getElementById('vitalPH').className = vitals.ph.critical ? 'vital-value vital-critical' : 'vital-value vital-normal';
        }
        if (vitals.inr) {
            document.getElementById('vitalINR').textContent = vitals.inr.value;
            document.getElementById('vitalINR').className = vitals.inr.critical ? 'vital-value vital-warning' : 'vital-value vital-normal';
        }
    }
}

// UI Controller
class SimulatorUI {
    constructor() {
        this.simulator = new ClinicalSimulator();
        this.feedbackCallback = null;
    }

    init(scenarioData) {
        this.simulator.loadScenario(scenarioData);
        this.updateDisplay();

        // Hide loading screen
        setTimeout(() => {
            document.getElementById('loadingScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('simulatorContainer').style.display = 'flex';
            }, 500);
        }, 1000);
    }

    updateDisplay() {
        const node = this.simulator.getCurrentNode();

        if (!node) return;

        // Handle different node types
        switch (node.type) {
            case 'scenario':
                this.displayScenario(node);
                break;
            case 'completion':
                this.displayCompletion(node);
                break;
        }

        // Update scores
        this.updateScores();

        // Update path history
        this.updatePathHistory();
    }

    displayScenario(node) {
        // Update title and content
        document.getElementById('statusTitle').textContent = node.title || 'Clinical Situation';
        document.getElementById('currentSituation').innerHTML = node.content.replace(/\n/g, '<br>');

        // Update vitals if specified
        if (node.vitals_update) {
            this.simulator.updateVitals(node.vitals_update);
        }

        // Display decisions
        const container = document.getElementById('decisionsContainer');
        container.innerHTML = '';

        if (node.decisions && node.decisions.length > 0) {
            node.decisions.forEach((decision, index) => {
                const button = document.createElement('div');
                button.className = 'decision-button';
                button.innerHTML = `
                    <div class="decision-label">Option ${index + 1}</div>
                    <div class="decision-text">${decision.text}</div>
                `;
                button.onclick = () => this.makeDecision(decision.id);
                container.appendChild(button);
            });
        }
    }

    async makeDecision(decisionId) {
        const result = this.simulator.makeDecision(decisionId);

        if (!result) return;

        // Show feedback
        await this.showFeedback(result);

        // Handle next action
        if (result.type === 'outcome') {
            // For outcome nodes, move to the next node
            if (result.actualNextNode) {
                this.simulator.currentNode = result.actualNextNode;
                this.updateDisplay();
            }
        } else if (result.type === 'scenario') {
            // For scenario nodes, we're already at the next node
            this.updateDisplay();
        } else if (result.type === 'completion') {
            // Show completion
            this.simulator.currentNode = result.nextNodeId;
            this.updateDisplay();
        }
    }

    showFeedback(result) {
        return new Promise((resolve) => {
            const modal = document.getElementById('feedbackModal');
            const header = document.getElementById('feedbackHeader');
            const text = document.getElementById('feedbackText');
            const refBox = document.getElementById('referenceBox');
            const refText = document.getElementById('referenceText');
            const points = document.getElementById('outcomePoints');

            // Set feedback content
            let icon, className, title;
            if (result.result === 'correct') {
                icon = '✅';
                className = 'feedback-correct';
                title = 'Correct Decision!';
            } else if (result.result === 'partial') {
                icon = '⚠️';
                className = 'feedback-partial';
                title = 'Partially Correct';
            } else {
                icon = '❌';
                className = 'feedback-incorrect';
                title = 'Incorrect Decision';
            }

            header.className = `feedback-header ${className}`;
            header.innerHTML = `<span class="feedback-icon">${icon}</span> ${title}`;
            text.textContent = result.feedback || '';

            // Show reference if available
            if (result.reference && this.simulator.scenarioData.references &&
                this.simulator.scenarioData.references[result.reference]) {
                refBox.style.display = 'block';
                refText.textContent = result.reference;
                this.simulator.currentReference = result.reference;
            } else {
                refBox.style.display = 'none';
            }

            // Show points
            points.innerHTML = `Points earned: <strong>${result.points}</strong>`;

            // Set up continue callback
            this.feedbackCallback = () => {
                modal.style.display = 'none';
                resolve();
            };

            // Show modal
            modal.style.display = 'flex';
        });
    }

    displayCompletion(node) {
        const scenarioPanel = document.querySelector('.scenario-panel');
        const decisionPanel = document.querySelector('.decision-panel');

        const totalPossibleScore = 30; // Calculate from scenario
        const percentage = Math.round((this.simulator.score / totalPossibleScore) * 100);

        scenarioPanel.innerHTML = `
            <div class="completion-screen">
                <div class="completion-title">${node.title}</div>
                <div style="font-size: 18px; margin-bottom: 30px;">${node.summary.replace(/\n/g, '<br>')}</div>

                <div class="completion-stats">
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.score}</div>
                        <div class="stat-label">Total Score</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${percentage}%</div>
                        <div class="stat-label">Performance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.correctDecisions}</div>
                        <div class="stat-label">Correct Decisions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${this.simulator.totalDecisions}</div>
                        <div class="stat-label">Total Decisions</div>
                    </div>
                </div>

                <button class="continue-button" onclick="location.reload()">Try Again</button>
            </div>
        `;

        decisionPanel.style.display = 'none';
    }

    updateScores() {
        document.getElementById('correctCount').textContent = this.simulator.correctDecisions;
        document.getElementById('stepCount').textContent = this.simulator.totalDecisions;
    }

    updatePathHistory() {
        const container = document.getElementById('pathHistory');
        container.innerHTML = '';

        this.simulator.pathHistory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `path-item ${item.result || ''} clickable`;

            div.innerHTML = `
                <strong>Step ${index + 1}:</strong> ${item.decision}
                ${item.result !== 'neutral' ? `<div class="path-result ${item.result}">→ ${item.result}</div>` : ''}
            `;

            div.onclick = () => this.showPathReview(item);
            container.appendChild(div);
        });
    }

    showPathReview(pathItem) {
        const modal = document.getElementById('feedbackModal');
        const header = document.getElementById('feedbackHeader');
        const text = document.getElementById('feedbackText');
        const refBox = document.getElementById('referenceBox');
        const refText = document.getElementById('referenceText');

        header.className = `feedback-header feedback-${pathItem.result}`;
        header.innerHTML = `Review: ${pathItem.nodeTitle}`;
        text.innerHTML = `<strong>Your Choice:</strong> ${pathItem.decision}<br><br>${pathItem.feedback || 'No feedback available.'}`;

        if (pathItem.reference) {
            refBox.style.display = 'block';
            refText.textContent = pathItem.reference;
            this.simulator.currentReference = pathItem.reference;
        } else {
            refBox.style.display = 'none';
        }

        modal.style.display = 'flex';
    }
}

// Global instance
const simulatorUI = new SimulatorUI();

// Liver failure scenario data
const liverFailureScenario = {
    "metadata": {
        "title": "Acute Liver Failure - Airway Emergency",
        "description": "Manage a critically ill patient with acute-on-chronic liver failure requiring emergent intubation",
        "specialty": "Critical Care/Emergency Medicine",
        "difficulty": "advanced",
        "duration": "15-20 min"
    },
    "initial_state": {
        "patient": {
            "demographics": "52-year-old female",
            "weight": "80 kg",
            "diagnosis": "Acute-on-chronic liver failure with sepsis"
        },
        "vitals": {
            "bp": {"value": "75/40 mmHg", "critical": true},
            "spo2": {"value": "85%", "critical": true},
            "ph": {"value": "7.18", "critical": true},
            "inr": {"value": "2.6", "critical": true}
        }
    },
    "nodes": {
        "start": {
            "type": "scenario",
            "title": "Initial Assessment",
            "content": "Patient presenting with:\n• Obtunded mental status (GCS 8)\n• Severe hemodynamic instability (SBP 75 mmHg)\n• Significant hypoxemia (SpO₂ 85% on NRB)\n• Severe metabolic acidosis (pH 7.18)\n• Large volume ascites\n• Coagulopathy (INR 2.6)\n\nUrgent airway evaluation required due to deteriorating respiratory status and inability to protect airway.",
            "decisions": [
                {"id": "immediate", "text": "Proceed with immediate intubation", "next": "immediate_intubation"},
                {"id": "assess", "text": "Assess risks and optimize physiology first", "next": "assess_risks"},
                {"id": "noninvasive", "text": "Trial of noninvasive ventilation", "next": "niv_trial"}
            ]
        },
        "immediate_intubation": {
            "type": "outcome",
            "result": "incorrect",
            "feedback": "Proceeding without optimization in this high-risk patient significantly increases the risk of peri-intubation cardiac arrest. Multiple modifiable risk factors are present that should be addressed first.",
            "reference": "Section 3.3: Risk Factors",
            "points": 0,
            "next": "start"
        },
        "niv_trial": {
            "type": "outcome",
            "result": "incorrect",
            "feedback": "NIV is contraindicated with obtunded mental status (GCS 8) due to aspiration risk. This patient cannot protect their airway and requires definitive airway management after optimization.",
            "reference": "Section 2.1: NIV Contraindications",
            "points": 0,
            "next": "start"
        },
        "assess_risks": {
            "type": "scenario",
            "title": "Pre-oxygenation Strategy",
            "content": "Risk assessment reveals:\n• Shock index 1.5 (HR 115/SBP 75)\n• Severe hypoxemia despite NRB mask\n• Metabolic acidosis\n• Coagulopathy\n\nAll are high-risk features for peri-intubation arrest.\n\nNext step: Optimize pre-oxygenation to prevent critical desaturation during intubation.",
            "result": "correct",
            "feedback": "Excellent decision! Recognizing and addressing modifiable risk factors before intubation significantly reduces complications in high-risk patients.",
            "reference": "Section 3.3: Risk Factors",
            "points": 10,
            "decisions": [
                {"id": "standard", "text": "Use standard face mask with 100% O₂", "next": "standard_mask"},
                {"id": "hfnc", "text": "Use high-flow nasal cannula with head of bed elevation", "next": "hfnc_preoxygenation"},
                {"id": "bvm", "text": "Bag-valve-mask ventilation", "next": "bvm_ventilation"}
            ]
        },
        "standard_mask": {
            "type": "outcome",
            "result": "incorrect",
            "feedback": "Standard face masks fail to create a tight seal and are limited by V/Q mismatch in liver failure. HFNC provides superior pre-oxygenation.",
            "reference": "Section 4.2: Hypoxemia Management",
            "points": 0,
            "next": "assess_risks"
        },
        "bvm_ventilation": {
            "type": "outcome",
            "result": "partial",
            "feedback": "While BVM can deliver high FiO₂, it risks gastric insufflation in a patient with ascites. HFNC is preferred for pre-oxygenation.",
            "reference": "Section 4.2: Hypoxemia Management",
            "points": 5,
            "next": "assess_risks"
        },
        "hfnc_preoxygenation": {
            "type": "scenario",
            "title": "Hemodynamic Optimization",
            "content": "Pre-oxygenation initiated with HFNC at 60L/min, FiO₂ 100%, HOB elevated to 30 degrees.\nSpO₂ improving to 91%.\n\nCurrent BP remains 75/40 mmHg. Need to address hemodynamics before intubation.\n\nPatient has received 2L crystalloid already with minimal response.",
            "result": "correct",
            "feedback": "HFNC with flows of 40-60L/min helps create an oxygen reservoir and provides 3-5 cmH₂O of PEEP.",
            "reference": "Section 4.2: Hypoxemia Management",
            "points": 10,
            "vitals_update": {
                "spo2": {"value": "91%", "critical": true}
            },
            "decisions": [
                {"id": "fluid", "text": "Give additional 500 mL fluid bolus", "next": "fluid_bolus"},
                {"id": "phenylephrine", "text": "Administer push-dose phenylephrine", "next": "phenylephrine"},
                {"id": "norepinephrine", "text": "Start norepinephrine infusion", "next": "completion"}
            ]
        },
        "fluid_bolus": {
            "type": "outcome",
            "result": "incorrect",
            "feedback": "This patient has non-volume responsive shock with large volume ascites. Additional fluid risks worsening pulmonary edema without improving hemodynamics.",
            "reference": "Section 4.3: RAPID Approach",
            "points": 0,
            "next": "hfnc_preoxygenation"
        },
        "phenylephrine": {
            "type": "scenario",
            "title": "Intubation Success",
            "content": "Push-dose phenylephrine (100 mcg) administered.\nBP improving to 95/55 mmHg within 60 seconds.\n\nPatient successfully intubated with ketamine induction.\n• First-pass success with video laryngoscopy\n• No hypotension or desaturation\n• Lung-protective ventilation initiated\n\nPost-intubation vitals:\n• BP: 105/60 mmHg\n• SpO₂: 96% on FiO₂ 60%\n• pH improving to 7.28",
            "result": "correct",
            "feedback": "Perfect choice! Push-dose phenylephrine provides rapid hemodynamic support without fluid overload.",
            "reference": "Section 4.3: RAPID Approach",
            "points": 10,
            "vitals_update": {
                "bp": {"value": "105/60 mmHg", "critical": false},
                "spo2": {"value": "96%", "critical": false},
                "ph": {"value": "7.28", "critical": false}
            },
            "decisions": [
                {"id": "complete", "text": "Complete Case Review", "next": "completion"}
            ]
        },
        "completion": {
            "type": "completion",
            "title": "Case Completed Successfully!",
            "summary": "Outstanding management of a high-risk airway!\n\nKey Learning Points:\n1. **Risk Stratification**: Always identify and modify risk factors before intubation\n2. **Pre-oxygenation**: HFNC superior to face mask in high-risk patients\n3. **Hemodynamic Optimization**: Push-dose pressors for immediate effect in distributive shock\n4. **Induction Agent Selection**: Ketamine ideal for hemodynamically unstable patients\n5. **Post-intubation Care**: Lung-protective ventilation and continued hemodynamic support"
        }
    },
    "references": {
        "Section 3.3: Risk Factors": {
            "title": "Risk Factors for Peri-intubation Cardiac Arrest",
            "content": "<h3>Major Risk Factors</h3><p>The following factors significantly increase the risk of adverse events during emergency intubation:</p><ul><li><strong>Hypotension:</strong> SBP <90 mmHg (10-fold increased risk)</li><li><strong>Hypoxemia:</strong> SpO₂ <90% despite optimization</li><li><strong>Severe Acidosis:</strong> pH <7.2</li><li><strong>Shock Index >0.9:</strong> HR/SBP ratio indicating hemodynamic instability</li></ul>"
        },
        "Section 2.1: NIV Contraindications": {
            "title": "Contraindications to Noninvasive Ventilation",
            "content": "<h3>Absolute Contraindications</h3><ul><li><strong>Inability to protect airway:</strong> GCS <8, absent gag reflex</li><li><strong>Cardiac or respiratory arrest</strong></li><li><strong>Severe hemodynamic instability</strong></li><li><strong>Active upper GI bleeding or vomiting</strong></li></ul>"
        },
        "Section 4.2: Hypoxemia Management": {
            "title": "Pre-oxygenation in High-Risk Patients",
            "content": "<h3>HFNC vs Standard Oxygen Delivery</h3><p>High-flow nasal cannula provides superior pre-oxygenation through:</p><ul><li>Delivery of up to 100% FiO₂</li><li>PEEP effect (3-5 cmH₂O)</li><li>Dead space washout</li><li>Ability to continue during intubation</li></ul>"
        },
        "Section 4.3: RAPID Approach": {
            "title": "Cardiovascular Optimization: RAPID Framework",
            "content": "<h3>Hemodynamic Patterns in Liver Failure</h3><p>Cirrhotic patients typically have distributive shock physiology:</p><ul><li>↓ Systemic vascular resistance (SVR)</li><li>↑ Cardiac output (hyperdynamic)</li><li>↓ Effective arterial blood volume</li></ul>"
        }
    }
};

// Global functions
function continuePath() {
    if (simulatorUI.feedbackCallback) {
        simulatorUI.feedbackCallback();
    }
}

function togglePathTracker() {
    const container = document.getElementById('pathHistoryContainer');
    const icon = document.querySelector('.path-toggle-icon');
    container.classList.toggle('collapsed');
    icon.textContent = container.classList.contains('collapsed') ? '▼' : '▲';
}

function showReference() {
    const reference = simulatorUI.simulator.scenarioData.references[simulatorUI.simulator.currentReference];
    if (!reference) return;

    const modal = document.getElementById('referenceModal');
    const title = document.getElementById('referenceTitle');
    const body = document.getElementById('referenceBody');

    title.textContent = reference.title;
    body.innerHTML = reference.content;

    modal.style.display = 'flex';
}

function closeReference() {
    document.getElementById('referenceModal').style.display = 'none';
}

function backToMenu() {
    window.location.href = 'scenario-menu.html';
}

// Keyboard shortcuts
document.addEventListener('keypress', (e) => {
    const num = parseInt(e.key);
    if (num >= 1 && num <= 9) {
        const buttons = document.querySelectorAll('.decision-button');
        if (buttons[num - 1]) {
            buttons[num - 1].click();
        }
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeReference();
        const feedbackModal = document.getElementById('feedbackModal');
        if (feedbackModal.style.display === 'flex') {
            continuePath();
        }
    }
});

// Initialize on load
window.onload = function() {
    simulatorUI.init(liverFailureScenario);
};
    </script>
</body>
</html>